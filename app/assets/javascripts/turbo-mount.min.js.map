{"version":3,"file":"turbo-mount.min.js","sources":["../src/turbo-mount-controller.ts","../src/helpers.ts","../src/turbo-mount.ts","../src/registerComponentsBase.ts"],"sourcesContent":["import { Controller } from \"@hotwired/stimulus\";\nimport { ApplicationWithTurboMount } from \"./turbo-mount\";\n\nexport class TurboMountController extends Controller {\n  static values = {\n    props: Object,\n    component: String,\n  };\n  static targets = [\"mount\"];\n\n  private skipPropsChangeCallback = false;\n\n  declare propsValue: object;\n  declare componentValue: string;\n  declare readonly hasMountTarget: boolean;\n  declare readonly mountTarget: Element;\n\n  _umountComponentCallback?: () => void;\n\n  connect() {\n    this._umountComponentCallback ||= this.mountComponent(\n      this.mountElement,\n      this.resolvedComponent,\n      this.componentProps,\n    );\n  }\n\n  disconnect() {\n    this.umountComponent();\n  }\n\n  propsValueChanged() {\n    // Prevent re-mounting the component if the props are being set by the component itself\n    if (this.skipPropsChangeCallback) {\n      this.skipPropsChangeCallback = false;\n      return;\n    }\n\n    this.umountComponent();\n    this._umountComponentCallback ||= this.mountComponent(\n      this.mountElement,\n      this.resolvedComponent,\n      this.componentProps,\n    );\n  }\n\n  get componentProps() {\n    return this.propsValue;\n  }\n\n  get mountElement() {\n    return this.hasMountTarget ? this.mountTarget : this.element;\n  }\n\n  get resolvedComponent() {\n    return this.resolveMounted(this.componentValue).component;\n  }\n\n  get resolvedPlugin() {\n    return this.resolveMounted(this.componentValue).plugin;\n  }\n\n  umountComponent() {\n    this._umountComponentCallback?.();\n    this._umountComponentCallback = undefined;\n  }\n\n  mountComponent(el: Element, Component: unknown, props: object) {\n    return this.resolvedPlugin.mountComponent({ el, Component, props });\n  }\n\n  resolveMounted(component: string) {\n    const app = this.application as ApplicationWithTurboMount;\n    return app.turboMount.resolve(component);\n  }\n\n  setComponentProps(props: object) {\n    this.skipPropsChangeCallback = true;\n    this.propsValue = props;\n  }\n}\n","export const camelToKebabCase = (str: string) => {\n  return str.replace(/([a-z])([A-Z])/g, \"$1-$2\").toLowerCase();\n};\n","import { Application, ControllerConstructor } from \"@hotwired/stimulus\";\n\nimport { camelToKebabCase } from \"./helpers\";\nimport { TurboMountController } from \"./turbo-mount-controller\";\n\ndeclare global {\n  interface Window {\n    Stimulus?: Application;\n  }\n}\n\nexport interface ApplicationWithTurboMount extends Application {\n  turboMount: TurboMount;\n}\n\nexport type MountComponentProps<T> = {\n  el: Element;\n  Component: T;\n  props: object;\n};\n\nexport type Plugin<T> = {\n  mountComponent: (props: MountComponentProps<T>) => () => void;\n};\n\nexport type TurboMountProps = {\n  application?: Application;\n};\n\ntype TurboMountComponents<T> = Map<string, { component: T; plugin: Plugin<T> }>;\n\ninterface TurboMorphEvent extends CustomEvent {\n  target: Element;\n  detail: {\n    newElement: Element;\n  };\n}\n\nexport class TurboMount {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  components: TurboMountComponents<any>;\n  application: ApplicationWithTurboMount;\n\n  constructor(props: TurboMountProps = {}) {\n    this.components = new Map();\n    this.application = this.findOrStartApplication(props.application);\n    this.application.turboMount = this;\n    this.application.register(\"turbo-mount\", TurboMountController);\n\n    document.addEventListener(\"turbo:before-morph-element\", (event) => {\n      const turboMorphEvent = event as unknown as TurboMorphEvent;\n      const { target, detail } = turboMorphEvent;\n\n      if (target.getAttribute(\"data-controller\")?.includes(\"turbo-mount\")) {\n        target.setAttribute(\n          \"data-turbo-mount-props-value\",\n          detail.newElement.getAttribute(\"data-turbo-mount-props-value\") ||\n            \"{}\",\n        );\n        event.preventDefault();\n      }\n    });\n  }\n\n  register<T>(\n    plugin: Plugin<T>,\n    name: string,\n    component: T,\n    controller?: ControllerConstructor,\n  ) {\n    controller ||= TurboMountController;\n    if (this.components.has(name)) {\n      throw new Error(`Component '${name}' is already registered.`);\n    }\n    this.components.set(name, { component, plugin });\n\n    if (controller) {\n      const controllerName = `turbo-mount-${camelToKebabCase(name)\n        .replace(/_/g, \"-\")\n        .replace(/\\//g, \"--\")}`;\n      this.application.register(controllerName, controller);\n    }\n  }\n\n  resolve(name: string) {\n    const component = this.components.get(name);\n    if (!component) {\n      throw new Error(`Unknown component: ${name}`);\n    }\n    return component;\n  }\n\n  private findOrStartApplication(hydratedApp?: Application) {\n    let application = hydratedApp || window.Stimulus;\n\n    if (!application) {\n      application = Application.start();\n      window.Stimulus = application;\n    }\n    return application as ApplicationWithTurboMount;\n  }\n}\n\nexport function buildRegisterFunction<T>(plugin: Plugin<T>) {\n  return (\n    turboMount: TurboMount,\n    name: string,\n    component: T,\n    controller?: ControllerConstructor,\n  ) => {\n    turboMount.register(plugin, name, component, controller);\n  };\n}\n","import { Definition } from \"@hotwired/stimulus\";\nimport { TurboMount, Plugin } from \"./turbo-mount\"; \nimport { camelToKebabCase } from \"./helpers\"; \n\nexport type ComponentModule = { default: never } | never;\n\nexport type ComponentDefinition = {\n  filename: string;\n  module: ComponentModule;\n};\n\nexport type RegisterComponentsProps<T> = {\n  plugin: Plugin<T>;\n  turboMount: TurboMount;\n  components: ComponentDefinition[];\n  controllers?: Definition[];\n};\n\n// Normalizes a component filename into a standardized component name.\n// Example: './components/users/UserProfile.tsx' -> 'users/user-profile'\n// Example: 'global/utility/debounce_button.js' -> 'global/utility/debounce-button'\nconst normalizeFilenameToComponentName = (filename: string): string => {\n  return (\n    filename\n      .replace(/\\.\\w*$/, \"\")\n      .replace(/^[./]*components\\//, \"\")\n      .split('/')\n      .map(part => camelToKebabCase(part).replace(/_/g, \"-\"))\n      .join('/')\n  );\n};\n\nconst generateStimulusIdentifiers = (componentName: string): string[] => {\n  const baseIdentifier = componentName.replace(/\\//g, \"--\");\n  return [`turbo-mount--${baseIdentifier}`, `turbo-mount-${baseIdentifier}`];\n};\n\n\n// Registers multiple components with TurboMount, potentially linking them\n// to Stimulus controllers based on naming conventions. Handles 'index'\n// components by registering them under both their full path and the parent\n// directory name if available.\nexport const registerComponentsBase = <T>({\n  plugin,\n  turboMount,\n  components,\n  controllers = [],\n}: RegisterComponentsProps<T>) => {\n  const registeredNames = new Set<string>();\n  const indexComponentsToRegisterLater: Array<{ name: string; module: ComponentModule }> = [];\n\n  for (const { filename, module } of components) {\n    const componentName = normalizeFilenameToComponentName(filename);\n    const component = module.default ?? module;\n\n    console.debug(`[TurboMount Registration] Attempting to register: ${componentName} from ${filename}`);\n\n    registerSingleComponent({\n      plugin,\n      turboMount,\n      availableControllers: controllers,\n      componentName,\n      component,\n    });\n    registeredNames.add(componentName);\n\n    // If component path ends with '/index', prepare for possible registration\n    // under the shorter directory name in the second pass.\n    if (componentName.endsWith(\"/index\")) {\n      const shortName = componentName.replace(/\\/index$/, \"\");\n      if (shortName) {\n          indexComponentsToRegisterLater.push({ name: shortName, module });\n          console.debug(`[TurboMount Registration] Queuing index component for short name registration: ${shortName}`);\n      }\n    }\n  }\n\n  // --- Second Pass: Register 'index' components using their shorter directory name ---\n  // This pass ensures that an explicit component (e.g., 'button.js') takes\n  // precedence over an index component (e.g., 'button/index.js') if both\n  // would resolve to the same short name ('button').\n  for (const { name: shortName, module } of indexComponentsToRegisterLater) {\n    if (!registeredNames.has(shortName)) {\n        const component = module.default ?? module;\n\n        console.debug(`[TurboMount Registration] Attempting to register index component with short name: ${shortName}`);\n\n        registerSingleComponent({\n            plugin,\n            turboMount,\n            availableControllers: controllers,\n            componentName: shortName,\n            component,\n      });\n      registeredNames.add(shortName);\n    } else {\n        console.debug(`[TurboMount Registration] Skipping short name registration for '${shortName}' as it's already registered.`);\n    }\n  }\n\n  console.debug(`[TurboMount Registration] Final registered names:`, Array.from(registeredNames));\n};\n\nconst registerSingleComponent = <T>({\n  plugin,\n  turboMount,\n  availableControllers,\n  componentName,\n  component,\n}: {\n  plugin: Plugin<T>;\n  turboMount: TurboMount;\n  availableControllers: Definition[];\n  componentName: string;\n  component: T;\n}) => {\n  const potentialIdentifiers = generateStimulusIdentifiers(componentName);\n\n  const controllerDefinition = availableControllers.find(({ identifier }) =>\n    potentialIdentifiers.includes(identifier)\n  );\n\n  if (controllerDefinition) {\n    console.debug(`[TurboMount Registration] Registering '${componentName}' with Stimulus controller '${controllerDefinition.identifier}'`);\n    turboMount.register(\n      plugin,\n      componentName,\n      component,\n      controllerDefinition.controllerConstructor\n    );\n  } else {\n    console.debug(`[TurboMount Registration] Registering '${componentName}' without a specific Stimulus controller.`);\n    turboMount.register(plugin, componentName, component);\n  }\n};"],"names":["TurboMountController","Controller","constructor","this","skipPropsChangeCallback","connect","_umountComponentCallback","mountComponent","mountElement","resolvedComponent","componentProps","disconnect","umountComponent","propsValueChanged","propsValue","hasMountTarget","mountTarget","element","resolveMounted","componentValue","component","resolvedPlugin","plugin","undefined","el","Component","props","application","turboMount","resolve","setComponentProps","values","Object","String","targets","camelToKebabCase","str","replace","toLowerCase","TurboMount","components","Map","findOrStartApplication","register","document","addEventListener","event","turboMorphEvent","target","detail","getAttribute","includes","setAttribute","newElement","preventDefault","name","controller","has","Error","set","controllerName","get","hydratedApp","window","Stimulus","Application","start","buildRegisterFunction","normalizeFilenameToComponentName","filename","split","map","part","join","registerComponentsBase","controllers","registeredNames","Set","indexComponentsToRegisterLater","module","componentName","default","console","debug","registerSingleComponent","availableControllers","add","endsWith","shortName","push","Array","from","potentialIdentifiers","baseIdentifier","generateStimulusIdentifiers","controllerDefinition","find","identifier","controllerConstructor"],"mappings":"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"}